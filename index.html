<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SOL TRADE TRACKER</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            -webkit-tap-highlight-color: transparent;
        }

        html, body {
            background-color: #000;
            color: #fff;
            height: 100%;
            width: 100%;
            overflow: hidden;
            position: fixed;
            touch-action: manipulation;
            -webkit-overflow-scrolling: touch;
        }

        .screen {
            display: none;
            width: 100%;
            height: 100%;
            padding: 20px;
            position: fixed;
            top: 0;
            left: 0;
            overflow: hidden;
        }

        .active {
            display: flex;
            flex-direction: column;
        }

        /* Splash screen */
        .splash-container {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100%;
            width: 100%;
        }

        .splash-title {
            color: #fff;
            font-size: 24px;
            font-weight: 400;
            text-align: center;
        }

        /* Input screen */
        .input-container {
            max-width: 400px;
            width: 100%;
            margin: 0 auto;
            padding: 10px 0;
            overflow: hidden;
            height: 100%;
            display: flex;
            flex-direction: column;
        }

        .input-content {
            overflow-y: auto;
            flex: 1;
            padding: 10px 0;
            -webkit-overflow-scrolling: touch;
            scrollbar-width: none;
            -ms-overflow-style: none;
        }

        .input-content::-webkit-scrollbar {
            display: none;
        }

        h1 {
            text-align: center;
            margin-bottom: 30px;
            color: #fff;
            font-size: 24px;
            font-weight: 400;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 400;
            color: #aaa;
            font-size: 14px;
        }

        input, select {
            width: 100%;
            padding: 12px 16px;
            background-color: transparent;
            border: 1px solid #333;
            color: #fff;
            font-size: 16px;
            transition: border-color 0.2s;
            border-radius: 20px;
            -webkit-appearance: none;
            appearance: none;
        }

        input:focus, select:focus {
            outline: none;
            border-color: #fff;
        }

        .radio-group {
            display: flex;
            gap: 20px;
            margin-top: 8px;
        }

        .radio-option {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .radio-option input {
            width: auto;
        }

        button {
            width: 100%;
            padding: 16px;
            background-color: #fff;
            color: #000;
            border: none;
            border-radius: 20px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            margin-top: 20px;
            position: relative;
            overflow: hidden;
        }

        button:active {
            transform: scale(0.98);
        }

        button:hover {
            opacity: 0.9;
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        /* Tracking screen */
        .tracking-container {
            max-width: 500px;
            width: 100%;
            margin: 0 auto;
            padding: 10px 0;
            height: 100%;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .price-display {
            text-align: center;
            margin-bottom: -50px;
        }

        .current-price {
            font-size: 32px;
            font-weight: 400;
            margin-bottom: 4px;
        }

        .price-change {
            font-size: 14px;
            color: #aaa;
        }

        .positive {
            color: #4CAF50;
        }

        .negative {
            color: #F44336;
        }

        .progress-container {
            margin-bottom: 30px;
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            overflow: hidden;
        }

        .progress-bar {
            height: 2px;
            background-color: #333;
            margin: 20px 0;
            position: relative;
            border-radius: 1px;
        }

        .progress-indicator {
            position: absolute;
            top: 50%;
            width: 12px;
            height: 12px;
            background-color: #fff;
            border-radius: 50%;
            transform: translate(-50%, -50%);
            transition: left 0.5s ease;
        }

        .progress-labels {
            display: flex;
            justify-content: space-between;
            margin-top: -10px;
            font-size: 14px;
        }

        .sl-label {
            color: #F44336;
        }

        .tp-label {
            color: #4CAF50;
        }

        .trade-details {
            margin-top: 30px;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .trade-detail {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #333;
        }

        .trade-detail:last-child {
            border-bottom: none;
        }

        .back-button {
            background-color: #333;
            color: #fff;
            margin-top: 30px;
        }

        .error-message {
            color: #F44336;
            font-size: 14px;
            margin-top: 8px;
            display: none;
        }

        .pnl-display {
            text-align: center;
            margin-top: 0px;
            padding: 16px;
            border-radius: 20px;
            font-weight: 500;
        }

        .pnl-positive {
            background-color: rgba(76, 175, 80, 0.1);
            color: #4CAF50;
        }

        .pnl-negative {
            background-color: rgba(244, 67, 54, 0.1);
            color: #F44336;
        }

        .pnl-neutral {
            background-color: rgba(255, 255, 255, 0.1);
            color: #aaa;
        }

        /* Loading spinner */
        .spinner {
            display: none;
            width: 20px;
            height: 20px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
            margin: 0 auto;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Risk indicators */
        .risk-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-top: 8px;
            font-size: 14px;
        }

        .risk-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
        }

        .risk-low {
            background-color: #4CAF50;
        }

        .risk-medium {
            background-color: #FF9800;
        }

        .risk-high {
            background-color: #F44336;
        }

        /* Alert banners */
        .alert-banner {
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 16px;
            text-align: center;
            font-weight: 500;
            display: none;
            animation: fadeIn 0.5s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .alert-success {
            background-color: rgba(76, 175, 80, 0.1);
            color: #4CAF50;
            border: 1px solid rgba(76, 175, 80, 0.3);
        }

        .alert-danger {
            background-color: rgba(244, 67, 54, 0.1);
            color: #F44336;
            border: 1px solid rgba(244, 67, 54, 0.3);
        }

        .trade-direction {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 8px;
            font-size: 12px;
            font-weight: 500;
        }

        .long {
            background-color: rgba(76, 175, 80, 0.2);
            color: #4CAF50;
        }

        .short {
            background-color: rgba(244, 67, 54, 0.2);
            color: #F44336;
        }

        /* Price Chart - MIGLIORATA RISOLUZIONE */
        .chart-container {
            margin: 20px 0;
            height: 120px;
            position: relative;
            border-radius: 8px;
            overflow: hidden;
            background-color: #000;
        }

        #price-chart {
            width: 100%;
            height: 100%;
            display: block;
        }

        .chart-lines {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
        }

        .chart-line {
            position: absolute;
            left: 0;
            width: 100%;
            height: 1px;
        }

        .chart-line.entry {
            border-top: 1px dashed rgba(255, 255, 255, 0.7);
        }

        .chart-line.tp {
            border-top: 1px dashed #4CAF50;
        }

        .chart-line.sl {
            border-top: 1px dashed #F44336;
        }

        .chart-label {
            position: absolute;
            right: 5px;
            font-size: 10px;
            padding: 2px 4px;
            border-radius: 2px;
            background-color: rgba(0, 0, 0, 0.7);
        }

        .chart-label.entry {
            color: rgba(255, 255, 255, 0.9);
        }

        .chart-label.tp {
            color: #4CAF50;
        }

        .chart-label.sl {
            color: #F44336;
        }

        /* Auto-refresh indicator */
        .auto-refresh-indicator {
            text-align: center;
            margin-top: 10px;
            font-size: 12px;
            color: #aaa;
            display: none;
        }

        /* Landscape mode warning */
        .landscape-warning {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: #000;
            color: #fff;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            font-size: 24px;
            text-align: center;
        }

        /* Swipeable buttons - SOLO 2 BOTTONI */
        .swipeable-buttons {
            display: flex;
            width: 100%;
            overflow: hidden;
            position: relative;
            height: 60px;
            margin-top: -60px;
        }

        .swipeable-track {
            display: flex;
            width: 200%; /* 2 bottoni */
            position: absolute;
            left: -50%; /* Centra il secondo bottone */
            transition: left 0.3s ease;
            height: 100%;
        }

        .swipeable-button {
            width: 50%; /* 2 bottoni */
            padding: 16px;
            background-color: #333;
            color: #fff;
            border: none;
            border-radius: 20px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            transition: opacity 0.2s;
            margin: 0;
            margin-right: 10px;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .swipeable-button:last-child {
            margin-right: 0;
        }

        .swipeable-button.active {
            background-color: #fff;
            color: #000;
        }

        /* Swipe indicators - SOLO 2 INDICATORI */
        .swipe-indicators {
            display: flex;
            justify-content: center;
            gap: 8px;
            margin-top: 10px;
        }

        .swipe-indicator {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background-color: #333;
            transition: background-color 0.3s;
        }

        .swipe-indicator.active {
            background-color: #fff;
        }

        /* TradingView Container - Integrato nel tracking screen */
        .tradingview-container {
            margin: 20px 0;
            height: 300px;
            border-radius: 12px;
            overflow: hidden;
            background: #000;
            display: none; /* Inizialmente nascosto */
        }

        .tradingview-frame {
            width: 100%;
            height: 100%;
            border: none;
            background: #000;
        }

        /* TradingView Toggle */
        .tradingview-toggle {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            margin: 10px 0;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .current-price {
                font-size: 28px;
            }
            
            .tradingview-container {
                height: 250px;
            }
        }

        @media (max-width: 480px) {
            .screen {
                padding: 16px;
            }
            
            .input-container, .tracking-container {
                padding: 5px 0;
            }
            
            .chart-container {
                height: 100px;
            }
            
            .tradingview-container {
                height: 200px;
            }
        }

        /* Landscape orientation lock */
        @media (orientation: landscape) and (max-width: 768px) {
            .screen {
                display: none !important;
            }
            .landscape-warning {
                display: flex;
            }
        }
    </style>
</head>
<body>
    <!-- Splash screen -->
    <div id="splash-screen" class="screen">
        <div class="splash-container">
            <h1 class="splash-title">SOL TRADE TRACKER</h1>
        </div>
    </div>

    <!-- Input screen -->
    <div id="input-screen" class="screen">
        <div class="input-container">
            <div class="input-content">
                
                <div class="alert-banner" id="input-alert"></div>
                
                <div class="form-group">
                    <label for="trade-amount">TRADE AMOUNT</label>
                    <input type="number" id="trade-amount" placeholder="Enter amount" step="0.01" min="0">
                    <div class="risk-indicator" id="amount-risk">
                        <div class="risk-dot risk-low"></div>
                        <span>Low risk</span>
                    </div>
                </div>
                
                <div class="form-group">
                    <label>CURRENCY</label>
                    <div class="radio-group">
                        <div class="radio-option">
                            <input type="radio" id="currency-usdt" name="currency" value="USDT" checked>
                            <label for="currency-usdt">USDT</label>
                        </div>
                        <div class="radio-option">
                            <input type="radio" id="currency-sol" name="currency" value="SOL">
                            <label for="currency-sol">SOL</label>
                        </div>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="entry-price">ENTRY PRICE (SOL)</label>
                    <input type="number" id="entry-price" placeholder="Entry price" step="0.0001" min="0">
                    <div class="error-message" id="entry-error"></div>
                </div>
                
                <div class="form-group">
                    <label for="tp-price">TAKE PROFIT (SOL)</label>
                    <input type="number" id="tp-price" placeholder="TP price" step="0.0001" min="0">
                    <div class="error-message" id="tp-error"></div>
                </div>
                
                <div class="form-group">
                    <label for="sl-price">STOP LOSS (SOL)</label>
                    <input type="number" id="sl-price" placeholder="SL price" step="0.0001" min="0">
                    <div class="error-message" id="sl-error"></div>
                </div>
                
                <div class="form-group">
                    <label for="leverage">LEVERAGE</label>
                    <select id="leverage">
                        <option value="1">1x</option>
                        <option value="2">2x</option>
                        <option value="3">3x</option>
                        <option value="5">5x</option>
                        <option value="10">10x</option>
                        <option value="20">20x</option>
                        <option value="25">25x</option>
                        <option value="50">50x</option>
                        <option value="100">100x</option>
                    </select>
                    <div class="risk-indicator" id="leverage-risk">
                        <div class="risk-dot risk-low"></div>
                        <span>Low risk</span>
                    </div>
                </div>
                
                <div class="form-group">
                    <div class="trade-detail">
                        <span>Risk/Reward Ratio</span>
                        <span id="risk-reward-ratio">--</span>
                    </div>
                </div>
            </div>
            
            <button id="start-tracking">
                <span id="button-text">START TRACKING</span>
                <div class="spinner" id="button-spinner"></div>
            </button>
        </div>
    </div>

    <!-- Tracking screen -->
    <div id="tracking-screen" class="screen">
        <div class="tracking-container">
            <div class="price-display">
                <div class="current-price" id="current-sol-price">--</div>
                <div class="price-change" id="price-change">Loading...</div>
            </div>
            
            <div class="alert-banner" id="tp-alert" class="alert-success">
                Take Profit reached!
            </div>
            
            <div class="alert-banner" id="sl-alert" class="alert-danger">
                Stop Loss reached!
            </div>
            
            <div class="progress-container">
                <div class="progress-labels">
                    <span class="sl-label" id="sl-percent">SL 0%</span>
                    <span class="tp-label" id="tp-percent">TP 0%</span>
                </div>
                
                <div class="progress-bar" id="progress-bar">
                    <div class="progress-indicator" id="progress-indicator"></div>
                </div>
                
                <!-- Price Chart - MIGLIORATA RISOLUZIONE -->
                <div class="chart-container">
                    <canvas id="price-chart"></canvas>
                    <div class="chart-lines" id="chart-lines"></div>
                </div>
                
                <!-- TradingView Toggle Button -->
                <button class="tradingview-toggle" id="tradingview-toggle">
                    ðŸ“ˆ SHOW TRADINGVIEW CHART
                </button>
                
                <!-- TradingView Container - Integrato direttamente -->
                <div class="tradingview-container" id="tradingview-container">
                    <iframe 
                        src="https://www.tradingview.com/chart/?symbol=BINANCE%3ASOLUSDT.P" 
                        class="tradingview-frame"
                        id="tradingview-frame"
                        allowfullscreen
                    ></iframe>
                </div>
                
                <div class="auto-refresh-indicator" id="auto-refresh-indicator">
                    Returning to input screen in <span id="countdown">5</span> seconds
                </div>
                
                <div class="pnl-display pnl-neutral" id="pnl-display">
                    P&L: -- (--%)
                </div>
                
                <div class="trade-details">
                    <div class="trade-detail">
                        <span>POSITION</span>
                        <span id="display-position-type"><span class="trade-direction long">LONG</span></span>
                    </div>
                    <div class="trade-detail">
                        <span>ENTRY</span>
                        <span id="display-entry-price">--</span>
                    </div>
                    <div class="trade-detail">
                        <span>STOP LOSS</span>
                        <span id="display-sl-price">--</span>
                    </div>
                    <div class="trade-detail">
                        <span>TAKE PROFIT</span>
                        <span id="display-tp-price">--</span>
                    </div>
                    <div class="trade-detail">
                        <span>LEVERAGE</span>
                        <span id="display-leverage">--</span>
                    </div>
                    <div class="trade-detail">
                        <span>RISK/REWARD</span>
                        <span id="display-risk-reward">--</span>
                    </div>
                </div>
            </div>
            
            <!-- Swipeable buttons - SOLO 2 BOTTONI -->
            <div class="swipeable-buttons">
                <div class="swipeable-track" id="swipeable-track">
                    <button class="swipeable-button" id="exchange-button">EXCHANGE</button>
                    <button class="swipeable-button active" id="new-trade-button">NEW TRADE</button>
                </div>
            </div>
            
            <!-- Swipe indicators - SOLO 2 INDICATORI -->
            <div class="swipe-indicators">
                <div class="swipe-indicator" data-index="0"></div>
                <div class="swipe-indicator active" data-index="1"></div>
            </div>
        </div>
    </div>

    <!-- Landscape mode warning -->
    <div class="landscape-warning">
        SOL TRADE TRACKER
    </div>

    <script>
        // DOM Elements
        const splashScreen = document.getElementById('splash-screen');
        const inputScreen = document.getElementById('input-screen');
        const trackingScreen = document.getElementById('tracking-screen');
        const startTrackingBtn = document.getElementById('start-tracking');
        
        // Swipeable buttons
        const swipeableTrack = document.getElementById('swipeable-track');
        const exchangeButton = document.getElementById('exchange-button');
        const newTradeButton = document.getElementById('new-trade-button');
        const swipeIndicators = document.querySelectorAll('.swipe-indicator');
        
        // TradingView elements
        const tradingviewToggle = document.getElementById('tradingview-toggle');
        const tradingviewContainer = document.getElementById('tradingview-container');
        const tradingviewFrame = document.getElementById('tradingview-frame');
        
        // Tracking elements
        const currentSolPrice = document.getElementById('current-sol-price');
        const priceChange = document.getElementById('price-change');
        const progressIndicator = document.getElementById('progress-indicator');
        const slPercent = document.getElementById('sl-percent');
        const tpPercent = document.getElementById('tp-percent');
        const pnlDisplay = document.getElementById('pnl-display');
        
        // Trade display elements
        const displayEntryPrice = document.getElementById('display-entry-price');
        const displaySlPrice = document.getElementById('display-sl-price');
        const displayTpPrice = document.getElementById('display-tp-price');
        const displayLeverage = document.getElementById('display-leverage');
        const displayPositionType = document.getElementById('display-position-type');
        const displayRiskReward = document.getElementById('display-risk-reward');
        
        // Form elements
        const tradeAmountInput = document.getElementById('trade-amount');
        const currencyUsdtRadio = document.getElementById('currency-usdt');
        const currencySolRadio = document.getElementById('currency-sol');
        const entryPriceInput = document.getElementById('entry-price');
        const tpPriceInput = document.getElementById('tp-price');
        const slPriceInput = document.getElementById('sl-price');
        const leverageSelect = document.getElementById('leverage');
        
        // Risk indicators
        const amountRiskIndicator = document.getElementById('amount-risk');
        const leverageRiskIndicator = document.getElementById('leverage-risk');
        const riskRewardRatio = document.getElementById('risk-reward-ratio');
        
        // Alert elements
        const inputAlert = document.getElementById('input-alert');
        const tpAlert = document.getElementById('tp-alert');
        const slAlert = document.getElementById('sl-alert');
        
        // Button elements
        const buttonText = document.getElementById('button-text');
        const buttonSpinner = document.getElementById('button-spinner');
        
        // Error elements
        const entryError = document.getElementById('entry-error');
        const tpError = document.getElementById('tp-error');
        const slError = document.getElementById('sl-error');
        
        // Chart elements
        const priceChart = document.getElementById('price-chart');
        const chartLines = document.getElementById('chart-lines');
        const autoRefreshIndicator = document.getElementById('auto-refresh-indicator');
        const countdownElement = document.getElementById('countdown');
        
        // Global variables
        let tradeData = {};
        let priceUpdateInterval;
        let previousPrice = 0;
        let isLongTrade = true;
        let lastApiCallTime = 0;
        const API_CALL_INTERVAL = 2000; // 2 seconds
        let priceHistory = [];
        const MAX_HISTORY_POINTS = 50;
        let chartContext;
        let autoRefreshTimer = null;
        let countdownValue = 5;
        let apiRetryCount = 0;
        const MAX_API_RETRIES = 3;
        let isTradingViewVisible = false;
        
        // Swipeable buttons variables - SOLO 2 BOTTONI
        let swipeStartX = 0;
        let swipeCurrentX = 0;
        let isSwiping = false;
        let currentButtonIndex = 1; // 0: Exchange, 1: New Trade

        // Storage keys
        const STORAGE_KEY = 'sol_trading_tracker_data';

        // Initialize the app
        function initApp() {
            setupEventListeners();
            setupSwipeHandling();
            
            // Check if we have a saved trade
            const savedData = loadFromLocalStorage();
            if (savedData && savedData.entryPrice) {
                tradeData = savedData;
                isLongTrade = savedData.tpPrice > savedData.entryPrice;
                populateFormWithSavedData(savedData);
                startTrackingWithData();
            } else {
                showScreen(splashScreen);
            }
            
            updateRiskIndicators();
            updateSwipeableButtons();
        }

        // Show screen with transition
        function showScreen(screen) {
            document.querySelectorAll('.screen').forEach(s => {
                s.classList.remove('active');
            });
            screen.classList.add('active');
            
            // Ridisegna il grafico quando viene mostrata la schermata di tracking
            if (screen === trackingScreen && chartContext && priceHistory.length > 0) {
                drawChart();
            }
        }

        // Setup event listeners
        function setupEventListeners() {
            // Button event listeners
            startTrackingBtn.addEventListener('click', startTracking);
            exchangeButton.addEventListener('click', openExchange);
            newTradeButton.addEventListener('click', goBack);
            tradingviewToggle.addEventListener('click', toggleTradingView);
            
            // Input change listeners for real-time validation
            tradeAmountInput.addEventListener('input', updateRiskIndicators);
            leverageSelect.addEventListener('change', updateRiskIndicators);
            entryPriceInput.addEventListener('input', updateRiskIndicators);
            slPriceInput.addEventListener('input', updateRiskIndicators);
            tpPriceInput.addEventListener('input', updateRiskIndicators);
            
            // Splash screen click handler
            splashScreen.addEventListener('click', () => showScreen(inputScreen));
        }

        // Setup swipe handling
        function setupSwipeHandling() {
            swipeableTrack.addEventListener('touchstart', (e) => {
                swipeStartX = e.touches[0].clientX;
                isSwiping = true;
            });

            swipeableTrack.addEventListener('touchmove', (e) => {
                if (!isSwiping) return;
                swipeCurrentX = e.touches[0].clientX;
            });

            swipeableTrack.addEventListener('touchend', () => {
                if (!isSwiping) return;
                
                const diff = swipeStartX - swipeCurrentX;
                const minSwipeDistance = 50;
                
                if (Math.abs(diff) > minSwipeDistance) {
                    if (diff > 0) {
                        // Swipe left
                        currentButtonIndex = Math.min(1, currentButtonIndex + 1);
                    } else {
                        // Swipe right
                        currentButtonIndex = Math.max(0, currentButtonIndex - 1);
                    }
                    updateSwipeableButtons();
                }
                
                isSwiping = false;
            });
        }

        // Toggle TradingView visibility
        function toggleTradingView() {
            isTradingViewVisible = !isTradingViewVisible;
            
            if (isTradingViewVisible) {
                tradingviewContainer.style.display = 'block';
                tradingviewToggle.textContent = 'ðŸ“ˆ HIDE TRADINGVIEW CHART';
                
                // Refresh the iframe to ensure it loads properly
                setTimeout(() => {
                    tradingviewFrame.src = tradingviewFrame.src;
                }, 100);
            } else {
                tradingviewContainer.style.display = 'none';
                tradingviewToggle.textContent = 'ðŸ“ˆ SHOW TRADINGVIEW CHART';
            }
        }

        // Update swipeable buttons - SOLO 2 BOTTONI
        function updateSwipeableButtons() {
            const offset = -100 * currentButtonIndex;
            swipeableTrack.style.left = `${offset}%`;
            
            // Update active button
            document.querySelectorAll('.swipeable-button').forEach((button, index) => {
                if (index === currentButtonIndex) {
                    button.classList.add('active');
                } else {
                    button.classList.remove('active');
                }
            });
            
            // Update indicators
            swipeIndicators.forEach((indicator, index) => {
                if (index === currentButtonIndex) {
                    indicator.classList.add('active');
                } else {
                    indicator.classList.remove('active');
                }
            });
        }

        // Initialize chart - MIGLIORATA RISOLUZIONE
        function initChart() {
            chartContext = priceChart.getContext('2d');
            
            // Miglioramento risoluzione per schermi retina
            const dpr = window.devicePixelRatio || 1;
            const rect = priceChart.getBoundingClientRect();
            
            priceChart.width = rect.width * dpr;
            priceChart.height = rect.height * dpr;
            
            chartContext.scale(dpr, dpr);
            
            // Imposta le dimensioni CSS per mantenere la dimensione visualizzata
            priceChart.style.width = rect.width + 'px';
            priceChart.style.height = rect.height + 'px';
            
            // Clear any existing data
            priceHistory = [];
        }

        // Draw price chart - MIGLIORATA RISOLUZIONE
        function drawChart() {
            if (priceHistory.length < 2) return;
            
            const width = priceChart.offsetWidth;
            const height = priceChart.offsetHeight;
            const ctx = chartContext;
            
            // Clear canvas
            ctx.clearRect(0, 0, width, height);
            
            // Calculate min and max prices for scaling
            let minPrice = Math.min(...priceHistory);
            let maxPrice = Math.max(...priceHistory);
            
            // Add some padding
            const priceRange = maxPrice - minPrice;
            minPrice -= priceRange * 0.1;
            maxPrice += priceRange * 0.1;
            
            // Draw chart line with improved quality
            ctx.beginPath();
            ctx.strokeStyle = '#fff';
            ctx.lineWidth = 3;
            ctx.lineJoin = 'round';
            ctx.lineCap = 'round';
            
            priceHistory.forEach((price, index) => {
                const x = (index / (priceHistory.length - 1)) * width;
                const y = height - ((price - minPrice) / (maxPrice - minPrice)) * height;
                
                if (index === 0) {
                    ctx.moveTo(x, y);
                } else {
                    ctx.lineTo(x, y);
                }
            });
            
            ctx.stroke();
            
            // Draw entry, TP and SL lines if available
            drawChartLines(minPrice, maxPrice, width, height);
        }

        // Draw horizontal lines for entry, TP and SL
        function drawChartLines(minPrice, maxPrice, width, height) {
            if (!tradeData.entryPrice) return;
            
            const ctx = chartContext;
            const entryY = height - ((tradeData.entryPrice - minPrice) / (maxPrice - minPrice)) * height;
            const tpY = height - ((tradeData.tpPrice - minPrice) / (maxPrice - minPrice)) * height;
            const slY = height - ((tradeData.slPrice - minPrice) / (maxPrice - minPrice)) * height;
            
            // Draw entry line
            ctx.beginPath();
            ctx.setLineDash([5, 3]);
            ctx.strokeStyle = 'rgba(255, 255, 255, 0.7)';
            ctx.lineWidth = 2;
            ctx.moveTo(0, entryY);
            ctx.lineTo(width, entryY);
            ctx.stroke();
            ctx.setLineDash([]);
            
            // Draw TP line
            ctx.beginPath();
            ctx.setLineDash([5, 3]);
            ctx.strokeStyle = '#4CAF50';
            ctx.lineWidth = 2;
            ctx.moveTo(0, tpY);
            ctx.lineTo(width, tpY);
            ctx.stroke();
            ctx.setLineDash([]);
            
            // Draw SL line
            ctx.beginPath();
            ctx.setLineDash([5, 3]);
            ctx.strokeStyle = '#F44336';
            ctx.lineWidth = 2;
            ctx.moveTo(0, slY);
            ctx.lineTo(width, slY);
            ctx.stroke();
            ctx.setLineDash([]);
        }

        // Input sanitization
        function sanitizeInput(value) {
            if (value === null || value === undefined) return 0;
            const str = value.toString().replace(/[^\d.-]/g, '');
            const num = parseFloat(str);
            return isNaN(num) ? 0 : Math.round(num * 100) / 100;
        }

        // Save to localStorage
        function saveToLocalStorage() {
            localStorage.setItem(STORAGE_KEY, JSON.stringify(tradeData));
        }

        // Load from localStorage
        function loadFromLocalStorage() {
            const savedData = localStorage.getItem(STORAGE_KEY);
            if (savedData) {
                return JSON.parse(savedData);
            }
            return null;
        }

        // Populate form with saved data
        function populateFormWithSavedData(savedData) {
            tradeAmountInput.value = savedData.amount || '';
            entryPriceInput.value = savedData.entryPrice || '';
            tpPriceInput.value = savedData.tpPrice || '';
            slPriceInput.value = savedData.slPrice || '';
            leverageSelect.value = savedData.leverage || '1';
            
            if (savedData.currency === 'SOL') {
                currencySolRadio.checked = true;
            } else {
                currencyUsdtRadio.checked = true;
            }
            
            updateRiskIndicators();
        }

        // Update risk indicators based on inputs
        function updateRiskIndicators() {
            const amount = sanitizeInput(tradeAmountInput.value);
            const leverage = parseInt(sanitizeInput(leverageSelect.value));
            const entry = sanitizeInput(entryPriceInput.value);
            const sl = sanitizeInput(slPriceInput.value);
            const tp = sanitizeInput(tpPriceInput.value);
            
            // Update amount risk
            if (amount > 1000) {
                amountRiskIndicator.innerHTML = '<div class="risk-dot risk-high"></div><span>High risk</span>';
            } else if (amount > 500) {
                amountRiskIndicator.innerHTML = '<div class="risk-dot risk-medium"></div><span>Medium risk</span>';
            } else {
                amountRiskIndicator.innerHTML = '<div class="risk-dot risk-low"></div><span>Low risk</span>';
            }
            
            // Update leverage risk
            if (leverage >= 20) {
                leverageRiskIndicator.innerHTML = '<div class="risk-dot risk-high"></div><span>High risk</span>';
            } else if (leverage >= 10) {
                leverageRiskIndicator.innerHTML = '<div class="risk-dot risk-medium"></div><span>Medium risk</span>';
            } else {
                leverageRiskIndicator.innerHTML = '<div class="risk-dot risk-low"></div><span>Low risk</span>';
            }
            
            // Update risk/reward ratio
            if (entry > 0 && sl > 0 && tp > 0) {
                // Determine trade direction based on TP and Entry
                const isLong = tp > entry;
                let risk, reward;
                
                if (isLong) {
                    risk = entry - sl;
                    reward = tp - entry;
                } else {
                    risk = sl - entry;
                    reward = entry - tp;
                }
                
                if (risk > 0) {
                    const ratio = (reward / risk).toFixed(2);
                    riskRewardRatio.textContent = `1:${ratio}`;
                } else {
                    riskRewardRatio.textContent = '--';
                }
            } else {
                riskRewardRatio.textContent = '--';
            }
        }

        // Get SOL price with fallbacks and retry mechanism
        async function getSolPriceWithFallbacks() {
            const now = Date.now();
            if (now - lastApiCallTime < API_CALL_INTERVAL && previousPrice > 0) {
                return previousPrice;
            }
            
            lastApiCallTime = now;
            
            // API endpoints with priority
            const endpoints = [
                {
                    url: 'https://api.binance.com/api/v3/ticker/price?symbol=SOLUSDT',
                    parser: data => parseFloat(data.price)
                },
                {
                    url: 'https://api.coingecko.com/api/v3/simple/price?ids=solana&vs_currencies=usd',
                    parser: data => parseFloat(data.solana.usd)
                }
            ];
            
            for (let i = 0; i < endpoints.length; i++) {
                try {
                    const response = await fetch(endpoints[i].url, {
                        method: 'GET',
                        headers: {
                            'Accept': 'application/json',
                        }
                    });
                    
                    if (response.ok) {
                        const data = await response.json();
                        const price = endpoints[i].parser(data);
                        if (price && price > 0) {
                            apiRetryCount = 0; // Reset retry count on success
                            return price;
                        }
                    }
                } catch (error) {
                    console.warn(`Failed to fetch from ${endpoints[i].url}:`, error);
                    continue;
                }
            }
            
            // If all endpoints fail, implement exponential backoff
            apiRetryCount++;
            const backoffDelay = Math.min(1000 * Math.pow(2, apiRetryCount), 30000); // Max 30 seconds
            
            console.warn(`All API endpoints failed. Retrying in ${backoffDelay}ms. Attempt: ${apiRetryCount}`);
            
            // Fallback - use previous price if available or generate realistic price
            if (previousPrice > 0) {
                return previousPrice;
            } else {
                // Generate a realistic SOL price with slight random variation
                return 150 + (Math.random() * 10 - 5);
            }
        }

        // Open exchange (TradingView web)
        function openExchange() {
            // Mostra/nascondi TradingView
            toggleTradingView();
        }

        // Validate trade data
        function validateTradeData(entry, sl, tp, amount, leverage) {
            // Reset errors
            entryError.style.display = 'none';
            tpError.style.display = 'none';
            slError.style.display = 'none';
            inputAlert.style.display = 'none';
            
            let isValid = true;
            
            // Basic validation
            if (!entry || entry <= 0) {
                entryError.textContent = 'Entry price must be greater than 0';
                entryError.style.display = 'block';
                isValid = false;
            }
            
            if (!tp || tp <= 0) {
                tpError.textContent = 'Take profit must be greater than 0';
                tpError.style.display = 'block';
                isValid = false;
            }
            
            if (!sl || sl <= 0) {
                slError.textContent = 'Stop loss must be greater than 0';
                slError.style.display = 'block';
                isValid = false;
            }
            
            if (!amount || amount <= 0) {
                inputAlert.textContent = 'Please enter a valid trade amount';
                inputAlert.className = 'alert-banner alert-danger';
                inputAlert.style.display = 'block';
                isValid = false;
            }
            
            // Leverage validation
            if (leverage <= 0 || leverage > 100) {
                inputAlert.textContent = 'Leverage must be between 1x and 100x';
                inputAlert.className = 'alert-banner alert-danger';
                inputAlert.style.display = 'block';
                isValid = false;
            }
            
            const totalExposure = amount * leverage;
            if (totalExposure > 1000000) {
                inputAlert.textContent = 'Total exposure (amount Ã— leverage) is too high';
                inputAlert.className = 'alert-banner alert-danger';
                inputAlert.style.display = 'block';
                isValid = false;
            }
            
            if (!isValid) return false;
            
            // Determine trade direction based on TP and Entry
            isLongTrade = tp > entry;
            
            // Trade logic validation
            if (isLongTrade) {
                if (sl >= entry) {
                    slError.textContent = 'For LONG trade, SL must be below entry price';
                    slError.style.display = 'block';
                    isValid = false;
                }
                
                if (tp <= entry) {
                    tpError.textContent = 'For LONG trade, TP must be above entry price';
                    tpError.style.display = 'block';
                    isValid = false;
                }
            } else {
                if (sl <= entry) {
                    slError.textContent = 'For SHORT trade, SL must be above entry price';
                    slError.style.display = 'block';
                    isValid = false;
                }
                
                if (tp >= entry) {
                    tpError.textContent = 'For SHORT trade, TP must be below entry price';
                    tpError.style.display = 'block';
                    isValid = false;
                }
            }
            
            // Check if SL and TP are too close to entry
            const minDistance = entry * 0.001; // 0.1% minimum distance
            if (isLongTrade) {
                if (entry - sl < minDistance) {
                    slError.textContent = 'Stop loss is too close to entry price';
                    slError.style.display = 'block';
                    isValid = false;
                }
                if (tp - entry < minDistance) {
                    tpError.textContent = 'Take profit is too close to entry price';
                    tpError.style.display = 'block';
                    isValid = false;
                }
            } else {
                if (sl - entry < minDistance) {
                    slError.textContent = 'Stop loss is too close to entry price';
                    slError.style.display = 'block';
                    isValid = false;
                }
                if (entry - tp < minDistance) {
                    tpError.textContent = 'Take profit is too close to entry price';
                    tpError.style.display = 'block';
                    isValid = false;
                }
            }
            
            return isValid;
        }

        // Calculate P&L
        function calculatePnL(currentPrice) {
            if (!tradeData.entryPrice || !tradeData.amount || !tradeData.leverage) return { value: 0, percentage: 0 };
            
            const entry = tradeData.entryPrice;
            const amount = tradeData.amount;
            const leverage = tradeData.leverage;
            const currency = tradeData.currency;
            
            let pnlValue, pnlPercentage;
            
            if (isLongTrade) {
                pnlPercentage = ((currentPrice - entry) / entry) * 100;
                pnlValue = ((currentPrice - entry) / entry) * amount * leverage;
            } else {
                pnlPercentage = ((entry - currentPrice) / entry) * 100;
                pnlValue = ((entry - currentPrice) / entry) * amount * leverage;
            }
            
            return {
                value: pnlValue,
                percentage: pnlPercentage
            };
        }

        // Update P&L display
        function updatePnLDisplay(currentPrice) {
            const pnl = calculatePnL(currentPrice);
            const currency = tradeData.currency || 'USDT';
            
            pnlDisplay.textContent = `P&L: ${pnl.value.toFixed(2)} ${currency} (${pnl.percentage.toFixed(2)}%)`;
            
            if (pnl.value > 0) {
                pnlDisplay.className = 'pnl-display pnl-positive';
            } else if (pnl.value < 0) {
                pnlDisplay.className = 'pnl-display pnl-negative';
            } else {
                pnlDisplay.className = 'pnl-display pnl-neutral';
            }
        }

        // Update progress bar
        function updateProgressBar(currentPrice) {
            if (!tradeData.entryPrice || !tradeData.slPrice || !tradeData.tpPrice) return;
            
            const entry = tradeData.entryPrice;
            const sl = tradeData.slPrice;
            const tp = tradeData.tpPrice;
            
            let distanceToSl, distanceToTp;
            
            if (isLongTrade) {
                distanceToSl = Math.max(0, ((entry - currentPrice) / (entry - sl)) * 100);
                distanceToTp = Math.max(0, ((currentPrice - entry) / (tp - entry)) * 100);
                
                // Check if TP or SL reached
                if (currentPrice >= tp) {
                    tpAlert.style.display = 'block';
                    slAlert.style.display = 'none';
                    startAutoRefresh();
                } else if (currentPrice <= sl) {
                    slAlert.style.display = 'block';
                    tpAlert.style.display = 'none';
                    startAutoRefresh();
                } else {
                    tpAlert.style.display = 'none';
                    slAlert.style.display = 'none';
                    stopAutoRefresh();
                }
            } else {
                distanceToSl = Math.max(0, ((currentPrice - entry) / (sl - entry)) * 100);
                distanceToTp = Math.max(0, ((entry - currentPrice) / (entry - tp)) * 100);
                
                // Check if TP or SL reached
                if (currentPrice <= tp) {
                    tpAlert.style.display = 'block';
                    slAlert.style.display = 'none';
                    startAutoRefresh();
                } else if (currentPrice >= sl) {
                    slAlert.style.display = 'block';
                    tpAlert.style.display = 'none';
                    startAutoRefresh();
                } else {
                    tpAlert.style.display = 'none';
                    slAlert.style.display = 'none';
                    stopAutoRefresh();
                }
            }
            
            slPercent.textContent = `SL ${distanceToSl.toFixed(1)}%`;
            tpPercent.textContent = `TP ${distanceToTp.toFixed(1)}%`;
            
            let indicatorPosition;
            if (isLongTrade) {
                indicatorPosition = ((currentPrice - sl) / (tp - sl)) * 100;
            } else {
                indicatorPosition = ((currentPrice - tp) / (sl - tp)) * 100;
            }
            
            indicatorPosition = Math.max(0, Math.min(100, indicatorPosition));
            progressIndicator.style.left = `${indicatorPosition}%`;
        }

        // Start auto-refresh countdown when TP/SL is reached
        function startAutoRefresh() {
            if (autoRefreshTimer) return;
            
            autoRefreshIndicator.style.display = 'block';
            countdownValue = 5;
            countdownElement.textContent = countdownValue;
            
            autoRefreshTimer = setInterval(() => {
                countdownValue--;
                countdownElement.textContent = countdownValue;
                
                if (countdownValue <= 0) {
                    stopAutoRefresh();
                    goBack();
                }
            }, 1000);
        }

        // Stop auto-refresh countdown
        function stopAutoRefresh() {
            if (autoRefreshTimer) {
                clearInterval(autoRefreshTimer);
                autoRefreshTimer = null;
            }
            autoRefreshIndicator.style.display = 'none';
        }

        // Show loading state
        function showLoading() {
            buttonText.style.display = 'none';
            buttonSpinner.style.display = 'block';
            startTrackingBtn.disabled = true;
        }

        // Hide loading state
        function hideLoading() {
            buttonText.style.display = 'block';
            buttonSpinner.style.display = 'none';
            startTrackingBtn.disabled = false;
        }

        // Start tracking
        async function startTracking() {
            showLoading();
            
            const tradeAmount = sanitizeInput(tradeAmountInput.value);
            const currency = document.querySelector('input[name="currency"]:checked').value;
            const entryPrice = sanitizeInput(entryPriceInput.value);
            const tpPrice = sanitizeInput(tpPriceInput.value);
            const slPrice = sanitizeInput(slPriceInput.value);
            const leverage = parseInt(sanitizeInput(leverageSelect.value));
            
            if (!validateTradeData(entryPrice, slPrice, tpPrice, tradeAmount, leverage)) {
                hideLoading();
                return;
            }
            
            tradeData = {
                amount: tradeAmount,
                currency: currency,
                entryPrice: entryPrice,
                tpPrice: tpPrice,
                slPrice: slPrice,
                leverage: leverage
            };
            
            saveToLocalStorage();
            await startTrackingWithData();
            hideLoading();
        }

        // Start tracking with existing data
        async function startTrackingWithData() {
            displayEntryPrice.textContent = `${tradeData.entryPrice.toFixed(2)}`;
            displaySlPrice.textContent = `${tradeData.slPrice.toFixed(2)}`;
            displayTpPrice.textContent = `${tradeData.tpPrice.toFixed(2)}`;
            displayLeverage.textContent = `${tradeData.leverage}x`;
            
            // Calculate and display risk/reward
            let risk, reward;
            if (isLongTrade) {
                risk = tradeData.entryPrice - tradeData.slPrice;
                reward = tradeData.tpPrice - tradeData.entryPrice;
                displayPositionType.innerHTML = `<span class="trade-direction long">LONG</span>`;
            } else {
                risk = tradeData.slPrice - tradeData.entryPrice;
                reward = tradeData.entryPrice - tradeData.tpPrice;
                displayPositionType.innerHTML = `<span class="trade-direction short">SHORT</span>`;
            }
            
            if (risk > 0) {
                const ratio = (reward / risk).toFixed(2);
                displayRiskReward.textContent = `1:${ratio}`;
            } else {
                displayRiskReward.textContent = '--';
            }
            
            showScreen(trackingScreen);
            
            // Initialize chart
            initChart();
            
            // Set the first button to "Exchange"
            currentButtonIndex = 0;
            updateSwipeableButtons();
            
            await updatePrice();
            priceUpdateInterval = setInterval(updatePrice, API_CALL_INTERVAL);
        }

        // Update price
        async function updatePrice() {
            try {
                const price = await getSolPriceWithFallbacks();
                currentSolPrice.textContent = `${price.toFixed(2)} SOL`;
                
                if (previousPrice > 0) {
                    const change = ((price - previousPrice) / previousPrice) * 100;
                    const changeFormatted = change.toFixed(2);
                    
                    if (change > 0) {
                        priceChange.innerHTML = `+${changeFormatted}%`;
                        priceChange.className = 'price-change positive';
                    } else if (change < 0) {
                        priceChange.innerHTML = `${changeFormatted}%`;
                        priceChange.className = 'price-change negative';
                    } else {
                        priceChange.textContent = '0.00%';
                        priceChange.className = 'price-change';
                    }
                }
                
                previousPrice = price;
                
                // Add to price history
                priceHistory.push(price);
                if (priceHistory.length > MAX_HISTORY_POINTS) {
                    priceHistory.shift();
                }
                
                // Update chart
                drawChart();
                
                updateProgressBar(price);
                updatePnLDisplay(price);
            } catch (error) {
                console.error('Error updating price:', error);
                priceChange.textContent = 'Price update failed';
                priceChange.className = 'price-change negative';
            }
        }

        // Go back to input screen
        function goBack() {
            stopAutoRefresh();
            showScreen(inputScreen);
            clearInterval(priceUpdateInterval);
            
            // Reset alerts
            tpAlert.style.display = 'none';
            slAlert.style.display = 'none';
            
            // Hide TradingView if visible
            if (isTradingViewVisible) {
                toggleTradingView();
            }
        }

        // Initialize the app when DOM is loaded
        document.addEventListener('DOMContentLoaded', initApp);

        // Handle window resize
        window.addEventListener('resize', () => {
            if (chartContext && trackingScreen.classList.contains('active')) {
                initChart();
                drawChart();
            }
        });

        // Prevent default behaviors
        document.addEventListener('touchmove', function(e) {
            if (e.target.tagName !== 'INPUT' && e.target.tagName !== 'SELECT' && e.target.tagName !== 'TEXTAREA') {
                e.preventDefault();
            }
        }, { passive: false });
        
        document.addEventListener('gesturestart', function(e) {
            e.preventDefault();
        });
        
        document.addEventListener('gesturechange', function(e) {
            e.preventDefault();
        });
        
        document.addEventListener('gestureend', function(e) {
            e.preventDefault();
        });

        // Disable double tap zoom
        let lastTouchEnd = 0;
        document.addEventListener('touchend', function(e) {
            const now = (new Date()).getTime();
            if (now - lastTouchEnd <= 300) {
                e.preventDefault();
            }
            lastTouchEnd = now;
        }, false);
    </script>
</body>
</html>
